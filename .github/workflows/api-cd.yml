name: Api Deploy on Google

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

defaults:
  run:
    working-directory: api

jobs:
  build-api:
    permissions:
      id-token: write
      contents: read
    name: Build and push to Google ACR
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: 'setup-qemu'
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - id: 'docker-buildx-setup'
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: 'beer-pong-441815'
            # create_credentials_file: true
            # token_format: access_token
          workload_identity_provider: 'projects/5685154754/locations/global/workloadIdentityPools/github/providers/github-actions'
            # service_account: 'cd-beerpong@beer-pong-441815.iam.gserviceaccount.com'
      - id: 'login-gar'
        name: "Login to GAR"
        uses: docker/login-action@v3
        with:
          registry: europe-west10-docker.pkg.dev/beer-pong-441815/api-beerpong
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}
      - id: 'build-and-push'
        name: 'Build and Push docker Image'
        uses: docker/build-push-action@v5
        with:
          push: true
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          tags: europe-west10-docker.pkg.dev/beer-pong-441815/api-beerpong:${{ github.sha }}

  deploy-api:
    permissions:
      id-token: write
      contents: read
    name: "Deploy api on Cloud Run"
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    needs: build-api
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          create_credentials_file: true
          token_format: access_token
          workload_identity_provider: 'projects/5685154754/locations/global/workloadIdentityPools/cd-beerpong/providers/github-actions'
          service_account: 'cd-beerpong@beer-pong-441815.iam.gserviceaccount.com'
      - id: 'deploy'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'backstage-deployment'
          image: 'europe-west10-docker.pkg.dev/beer-pong-441815/api-beerpong${{ github.sha }}'
          region: europe-west1
          flags: '--port=8080 --add-cloudsql-instances=beer-pong-441815:europe-west10:api-beerpong-pg'
          env_vars: |
            POSTGRES_PORT=5432
            POSTGRES_USER=postgres
            POSTGRES_URL='jdbc:postgresql:///beerpong?cloudSqlInstance=beer-pong-441815:europe-west10:api-beerpong-pg&socketFactory=com.google.cloud.sql.postgres.SocketFactory'
          secrets: |-
            POSTGRES_PASSWORD=api-pg-password:latest
